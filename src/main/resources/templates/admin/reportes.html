<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reportes de Ventas</title>
    <!-- Agregar Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div th:replace="fragments/header :: head('Reportes de Ventas')"></div>
</head>
<body>
<div th:replace="fragments/header :: navbar"></div>
<div class="container mt-4">
    <h2 class="mb-4">Reportes de Ventas</h2>
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header"><strong>Filtros</strong></div>
        <div class="card-body">
            <form th:action="@{/admin/reportes}" method="get">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" name="fechaInicio" th:value="${fechaInicio}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" name="fechaFin" th:value="${fechaFin}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Mesero</label>
                        <select class="form-select" name="meseroId">
                            <option value="">Todos</option>
                            <option th:each="mesero : ${meseros}"
                                    th:value="${mesero.id}"
                                    th:text="${mesero.nombre}"
                                    th:selected="${mesero.id == meseroId}"></option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                        <a th:href="@{/admin/reportes}" class="btn btn-secondary">Limpiar</a>
                    </div>
                    <a th:href="@{'/admin/reportes/exportar'(fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, meseroId=${meseroId != null ? meseroId : ''})}" class="btn btn-success">
                        Exportar a Excel
                    </a>
                </div>
            </form>
        </div>
    </div>
    <!-- Resumen -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Ventas</h5>
                    <h3 class="card-text"
                        th:text="${'$' + #numbers.formatDecimal(totalVentas, 0, 'COMMA', 0, 'POINT')}"></h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Cantidad Pedidos</h5>
                    <h3 class="card-text" th:text="${cantidadPedidos}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Ticket Promedio</h5>
                    <h3 class="card-text"
                        th:text="${cantidadPedidos > 0 ? '$' + #numbers.formatDecimal(totalVentas / cantidadPedidos, 0, 'COMMA', 0, 'POINT') : '$0'}"></h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Tabla de pedidos -->
    <div class="card mb-4">
        <div class="card-header"><strong>Detalle de Pedidos</strong></div>
        <div class="card-body table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Mesero</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pedido : ${pedidos}">
                    <td th:text="${pedido.id}"></td>
                    <td th:text="${#temporals.format(pedido.fechaHora, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${pedido.mesa ?: 'Sin especificar'}"></td>
                    <td th:text="${pedido.usuarioNombre}"></td>
                    <td th:text="${'$' + #numbers.formatDecimal(pedido.total, 0, 'COMMA', 0, 'POINT')}"></td>
                    <td>
                            <span th:class="${pedido.estado == 'COMPLETADO' ? 'badge bg-success' :
                                             (pedido.estado == 'ANULADO' ? 'badge bg-danger' : 'badge bg-warning')}"
                                  th:text="${pedido.estado}"></span>
                    </td>
                    <td>
                        <a th:href="@{/pedidos/{id}(id=${pedido.id})}" class="btn btn-sm btn-info">Ver detalle</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Gráficas -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Ventas por Categoría</div>
                <div class="card-body">
                    <canvas id="chartCategorias"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Ventas por Día</div>
                <div class="card-body">
                    <canvas id="chartDias"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Chart.js script -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Categorías
        var dataCategorias = /*[[${ventasPorCategoria}]]*/ [];
        console.log("Ventas por Categoría:", dataCategorias); // <--- Añade esto

        new Chart(document.getElementById('chartCategorias'), {
            type: 'pie',
            data: {
                labels: dataCategorias.map(cat => cat.categoria),
                datasets: [{
                    data: dataCategorias.map(cat => cat.total),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40']
                }]
            }
        });

        // Días
        var dataDias = /*[[${ventasPorDia}]]*/ [];
        console.log("Ventas por Día:", dataDias); // <--- Y esto también

        new Chart(document.getElementById('chartDias'), {
            type: 'bar',
            data: {
                labels: dataDias.map(d => d.fecha),
                datasets: [{
                    label: 'Ventas por Día',
                    data: dataDias.map(d => d.total),
                    backgroundColor: '#36A2EB'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
